{% extends 'fleet_app/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ titre }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">{{ titre }}</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'fleet_app:dashboard' %}">Tableau de bord</a></li>
        <li class="breadcrumb-item"><a href="{% url 'fleet_app:facture_list' %}">Liste des Factures</a></li>
        <li class="breadcrumb-item"><a href="{% url 'fleet_app:facture_detail' facture.numero %}">Facture {{ facture.numero }}</a></li>
        <li class="breadcrumb-item active">{{ titre }}</li>
    </ol>
    
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-shopping-cart me-1"></i>
            Détails du produit
        </div>
        <div class="card-body">
            <form method="post" id="ligneFactureForm">
                {% csrf_token %}
                
                {% if form.errors %}
                <div class="alert alert-danger">
                    <strong>Des erreurs ont été détectées dans le formulaire :</strong>
                    <ul>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li>{{ field.label }} : {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="{{ form.produit.id_for_label }}" class="form-label">{{ form.produit.label }}</label>
                            {{ form.produit|add_class:"form-control" }}
                            {% if form.produit.help_text %}<small class="form-text text-muted">{{ form.produit.help_text }}</small>{% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                            {{ form.description|add_class:"form-control" }}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="{{ form.quantite.id_for_label }}" class="form-label">{{ form.quantite.label }}</label>
                            {{ form.quantite|add_class:"form-control" }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="{{ form.prix_unitaire.id_for_label }}" class="form-label">{{ form.prix_unitaire.label }} (GNF)</label>
                            {{ form.prix_unitaire|add_class:"form-control" }}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">Montant total</label>
                            <input type="text" id="montant_total" class="form-control" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'fleet_app:facture_detail' facture.numero %}" class="btn btn-secondary">Annuler</a>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Activer le menu Factures
        document.querySelector('#inventaire-menu').classList.add('active');
        
        // Récupérer les éléments du formulaire
        const produitSelect = document.getElementById('{{ form.produit.id_for_label }}');
        const descriptionInput = document.getElementById('{{ form.description.id_for_label }}');
        const quantiteInput = document.getElementById('{{ form.quantite.id_for_label }}');
        const prixUnitaireInput = document.getElementById('{{ form.prix_unitaire.id_for_label }}');
        const montantTotalInput = document.getElementById('montant_total');
        
        // Fonction pour calculer le montant total
        function calculerMontantTotal() {
            // Nettoyer les valeurs d'entrée (supprimer les espaces, les GNF, etc.)
            const quantiteValue = quantiteInput.value.replace(/[^0-9.]/g, '');
            const prixUnitaireValue = prixUnitaireInput.value.replace(/[^0-9.]/g, '');
            
            // Convertir en nombres pour le calcul côté client uniquement
            const quantite = parseInt(quantiteValue) || 0;
            const prixUnitaire = parseInt(prixUnitaireValue) || 0;
            
            // Calculer le montant total pour l'affichage
            const montantTotal = quantite * prixUnitaire;
            montantTotalInput.value = montantTotal.toLocaleString('fr-FR') + ' GNF';
        }
        
        // Calculer le montant total au chargement de la page
        calculerMontantTotal();
        
        // Recalculer le montant total lorsque la quantité ou le prix unitaire change
        quantiteInput.addEventListener('input', calculerMontantTotal);
        prixUnitaireInput.addEventListener('input', calculerMontantTotal);
        
        // Récupérer les informations du produit lorsqu'il est sélectionné
        produitSelect.addEventListener('change', function() {
            const produitId = this.value;
            if (produitId) {
                // Créer un objet FormData pour l'envoi des données
                const formData = new FormData();
                formData.append('produit_id', produitId);
                
                // Appel AJAX pour récupérer les informations du produit
                fetch('{% url "fleet_app:get_produit_info_facture" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        descriptionInput.value = data.nom_produit;
                        prixUnitaireInput.value = data.prix_unitaire;
                        calculerMontantTotal();
                    } else {
                        console.error('Erreur:', data.message);
                        alert('Erreur lors de la récupération des informations du produit: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur de communication avec le serveur');
                });
            }
        });
    });
</script>
{% endblock %}
