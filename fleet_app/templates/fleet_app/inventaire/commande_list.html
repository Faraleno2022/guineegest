{% extends 'fleet_app/base.html' %}
{% load static %}
{% load django_bootstrap5 %}

{% block title %}{{ titre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/scroller/2.0.5/css/scroller.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css">
<style>
    .badge {
        font-size: 0.9em;
    }
    .dataTables_wrapper .dataTables_filter {
        margin-bottom: 1rem;
    }
    .commande-numero {
        font-weight: 600;
    }
    .btn-group .btn {
        margin-right: 2px;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    .card-header {
        background-color: #f8f9fa;
    }
    .form-group {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">{{ titre }}</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'fleet_app:dashboard' %}">Tableau de bord</a></li>
        <li class="breadcrumb-item active">Commandes</li>
    </ol>
    
    <!-- Statistiques des commandes par statut -->
    <div class="row mb-4">
        <div class="col-xl-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-chart-pie me-1"></i>
                        Statistiques des commandes par statut
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Total des commandes -->
                        <div class="col-md-2 mb-3">
                            <div class="card bg-light text-dark h-100">
                                <div class="card-body py-3 text-center">
                                    <h3 class="display-4">{{ stats_commandes.total }}</h3>
                                    <div class="small">Total des commandes</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Brouillon -->
                        <div class="col-md-2 mb-3">
                            <div class="card bg-secondary text-white h-100">
                                <div class="card-body py-3 text-center">
                                    <h3 class="display-4">{{ stats_commandes.Brouillon }}</h3>
                                    <div class="small">Brouillon</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- En attente -->
                        <div class="col-md-2 mb-3">
                            <div class="card bg-warning text-dark h-100">
                                <div class="card-body py-3 text-center">
                                    <h3 class="display-4">{{ stats_commandes.En_attente }}</h3>
                                    <div class="small">En attente de validation</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Validée -->
                        <div class="col-md-2 mb-3">
                            <div class="card bg-primary text-white h-100">
                                <div class="card-body py-3 text-center">
                                    <h3 class="display-4">{{ stats_commandes.Validee }}</h3>
                                    <div class="small">Validée</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- En cours -->
                        <div class="col-md-2 mb-3">
                            <div class="card bg-info text-dark h-100">
                                <div class="card-body py-3 text-center">
                                    <h3 class="display-4">{{ stats_commandes.En_cours }}</h3>
                                    <div class="small">En cours de traitement</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Livrée -->
                        <div class="col-md-1 mb-3">
                            <div class="card bg-success text-white h-100">
                                <div class="card-body py-3 text-center">
                                    <h3 class="display-4">{{ stats_commandes.Livree }}</h3>
                                    <div class="small">Livrée</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Annulée -->
                        <div class="col-md-1 mb-3">
                            <div class="card bg-danger text-white h-100">
                                <div class="card-body py-3 text-center">
                                    <h3 class="display-4">{{ stats_commandes.Annulee }}</h3>
                                    <div class="small">Annulée</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-file-invoice me-1"></i>
                Recherche de commandes
            </div>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                {% bootstrap_form form_recherche layout='horizontal' %}
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Rechercher
                    </button>
                    <a href="{% url 'fleet_app:commande_list' %}" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Réinitialiser
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-file-invoice me-1"></i>
                Liste des commandes
            </div>
            <div class="btn-group">
                <a href="{% url 'fleet_app:commande_create' %}" class="btn btn-primary btn-sm" data-bs-toggle="tooltip" title="Créer une nouvelle commande">
                    <i class="fas fa-plus"></i> Nouvelle commande
                </a>
                <a href="{% url 'fleet_app:export_commandes_excel' %}" class="btn btn-success btn-sm" data-bs-toggle="tooltip" title="Exporter toutes les commandes au format Excel">
                    <i class="fas fa-file-excel"></i> Export Excel
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if commandes %}
                <table class="table table-striped table-hover" id="commandesTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Numéro</th>
                            <th>Date création</th>
                            <th>Fournisseur</th>
                            <th>Montant total</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for commande in commandes %}
                            <tr>
                                <td><span class="commande-numero">{{ commande.numero }}</span></td>
                                <td data-order="{{ commande.date_creation|date:'Y-m-d' }}">{{ commande.date_creation|date:"d/m/Y" }}</td>
                                <td>{{ commande.fournisseur }}</td>
                                <td data-order="{{ commande.montant_total }}">{{ commande.montant_total|floatformat:0 }} GNF</td>
                                <td>
                                    {% if commande.statut == 'Brouillon' %}
                                        <span class="badge bg-secondary">{{ commande.statut }}</span>
                                    {% elif commande.statut == 'En attente' %}
                                        <span class="badge bg-warning">{{ commande.statut }}</span>
                                    {% elif commande.statut == 'Confirmée' %}
                                        <span class="badge bg-primary">{{ commande.statut }}</span>
                                    {% elif commande.statut == 'Livrée' %}
                                        <span class="badge bg-success">{{ commande.statut }}</span>
                                    {% elif commande.statut == 'Annulée' %}
                                        <span class="badge bg-danger">{{ commande.statut }}</span>
                                    {% else %}
                                        <span class="badge bg-info">{{ commande.statut }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'fleet_app:commande_detail' pk=commande.numero %}" class="btn btn-sm btn-info" data-bs-toggle="tooltip" title="Voir les détails">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'fleet_app:commande_update' pk=commande.numero %}" class="btn btn-sm btn-warning" data-bs-toggle="tooltip" title="Modifier la commande">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'fleet_app:commande_delete' pk=commande.numero %}" class="btn btn-sm btn-danger btn-delete-commande" data-bs-toggle="tooltip" title="Supprimer la commande">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <!-- La pagination est maintenant gérée par DataTables -->
            {% else %}
                <div class="alert alert-info">
                    Aucune commande trouvée. <a href="{% url 'fleet_app:commande_create' %}" class="alert-link">Créer une nouvelle commande</a>.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/scroller/2.0.5/js/dataTables.scroller.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>

<script>
    $(document).ready(function() {
        // Initialisation de datepicker pour les champs de date
        $('input[type="date"]').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            language: 'fr',
            todayHighlight: true
        });
        
        // Initialisation de DataTables avec optimisations de performance
        $('#commandesTable').DataTable({
            // Optimisations de performance
            deferRender: true,      // Lazy loading - rendu différé des éléments
            scrollY: '50vh',        // Hauteur fixe pour le défilement vertical
            scroller: true,         // Activation du défilement virtuel
            scrollCollapse: true,   // Ajustement de la hauteur en fonction du contenu
            
            // Configuration responsive et langue
            responsive: true,
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/fr-FR.json'
            },
            
            // Configuration des colonnes et tri
            columnDefs: [
                { orderable: false, targets: -1 } // Désactiver le tri sur la colonne Actions
            ],
            order: [[1, 'desc']],   // Tri par défaut sur la date de création (descendant)
            
            // Configuration de la pagination
            pageLength: 25,         // Nombre d'éléments par page augmenté
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tous"]],
            
            // Configuration de l'interface
            dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"lB><"d-flex"f>>rtip',
            buttons: [
                {
                    text: '<i class="fas fa-sync-alt"></i>',
                    titleAttr: 'Actualiser',
                    className: 'btn btn-light me-2',
                    action: function (e, dt, node, config) {
                        dt.ajax.reload();
                    }
                }
            ]
        });
        
        // Ajouter des tooltips aux boutons d'action
        $('[data-bs-toggle="tooltip"]').tooltip();
        
        // Confirmation pour la suppression
        $('.btn-delete-commande').on('click', function(e) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette commande ? Cette action est irréversible.')) {
                e.preventDefault();
            }
        });
    });
</script>
{% endblock %}
