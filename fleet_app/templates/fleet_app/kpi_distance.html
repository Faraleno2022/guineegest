{% extends 'fleet_app/base.html' %}

{% block title %}KPI Distances - Gestion de Parc Automobile{% endblock %}

{% block extra_css %}
<style>
    /* Styles simples pour les champs de kilométrage */
    .km-input {
        text-align: right;
    }
    
    .km-input.is-valid {
        border-color: #28a745;
        background-color: #f0fff4;
    }
    
    .km-input.is-invalid {
        border-color: #dc3545;
        background-color: #fff5f5;
    }
    
    /* Animation pour le calcul de la distance */
    @keyframes highlight {
        0% { background-color: #fff; }
        50% { background-color: #e6f7ff; }
        100% { background-color: #fff; }
    }
    
    .highlight-calculation {
        animation: highlight 1s ease;
    }
</style>
{% endblock %}

{% block page_title %}KPI Distances Parcourues{% endblock %}

{% block content %}
<div class="row">
    <!-- Formulaire d'ajout -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header {% if edit_mode %}bg-warning{% else %}bg-primary{% endif %} text-white d-flex justify-content-between align-items-center">
                <div>
                    {% if edit_mode %}
                    <i class="fas fa-edit me-2"></i> <strong>Modifier la distance parcourue</strong>
                    {% else %}
                    <i class="fas fa-plus-circle me-2"></i> <strong>Ajouter une distance parcourue</strong>
                    {% endif %}
                </div>
                <div>
                    <span class="badge bg-light text-dark">Formulaire de saisie</span>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i> Remplissez ce formulaire pour enregistrer une nouvelle distance parcourue ou modifier une existante. La distance sera calculée automatiquement à partir des kilométrages de début et de fin.
                </div>
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.vehicule.id_for_label }}" class="form-label">Véhicule</label>
                            {{ form.vehicule }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Période</label>
                            <div class="input-group">
                                <span class="input-group-text">Du</span>
                                {{ form.date_debut }}
                                <span class="input-group-text">au</span>
                                {{ form.date_fin }}
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="{{ form.km_debut.id_for_label }}" class="form-label">
                                <i class="fas fa-tachometer-alt me-1" data-bs-toggle="tooltip" title="Kilométrage au début de la période"></i> Km début
                            </label>
                            <div class="input-group">
                                {{ form.km_debut }}
                                <span class="input-group-text">km</span>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="{{ form.km_fin.id_for_label }}" class="form-label">
                                <i class="fas fa-tachometer-alt me-1" data-bs-toggle="tooltip" title="Kilométrage à la fin de la période"></i> Km fin
                            </label>
                            <div class="input-group">
                                {{ form.km_fin }}
                                <span class="input-group-text">km</span>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="{{ form.distance_parcourue.id_for_label }}" class="form-label">
                                <i class="fas fa-road me-1" data-bs-toggle="tooltip" title="Distance parcourue (calculée automatiquement)"></i> Distance
                            </label>
                            <div class="input-group">
                                {{ form.distance_parcourue }}
                                <span class="input-group-text">km</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.limite_annuelle.id_for_label }}" class="form-label">Limite annuelle (km)</label>
                            {{ form.limite_annuelle }}
                        </div>
                    </div>
                    <div class="text-end">
                        {% if edit_mode %}
                        <a href="{% url 'fleet_app:kpi_distance' %}" class="btn btn-secondary me-2">
                            <i class="fas fa-times me-2"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save me-2"></i> Mettre à jour
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i> Enregistrer
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Graphique des distances totales -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-chart-bar me-2"></i> <strong>Distances totales par véhicule</strong>
                </div>
                <div>
                    <select id="periodeSelect" class="form-select form-select-sm">
                        <option value="all">Toutes les périodes</option>
                        <option value="month">Dernier mois</option>
                        <option value="quarter">Dernier trimestre</option>
                        <option value="year">Dernière année</option>
                    </select>
                </div>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="distancesChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Statistiques des distances -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="fas fa-tachometer-alt me-2"></i> <strong>Statistiques globales</strong>
            </div>
            <div class="card-body">
                <div class="stat-card">
                    <i class="fas fa-road fa-2x text-primary"></i>
                    <div class="stat-value" id="distanceTotale">Chargement...</div>
                    <div class="stat-label">Distance totale parcourue</div>
                </div>
                <hr>
                <div class="stat-card">
                    <i class="fas fa-car"></i>
                    <div class="stat-value" id="moyenneParVehicule">Chargement...</div>
                    <div class="stat-label">Moyenne par véhicule</div>
                </div>
                <hr>
                <div class="stat-card">
                    <i class="fas fa-trophy"></i>
                    <div class="stat-value" id="vehiculePlusKm">Chargement...</div>
                    <div class="stat-label">Véhicule avec le plus de km</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tableau des distances -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-list me-2"></i> Détail des distances parcourues
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#distanceModal">
                        <i class="fas fa-plus"></i> Ajouter
                    </button>
                    <button type="button" class="btn btn-sm btn-primary" onclick="exportTableToExcel('distanceTable', 'Distances_Parcourues')">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="exportTableToPDF('distanceTable', 'Distances_Parcourues')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Formulaire de recherche -->
                <form method="get" class="mb-4">
                    <div class="input-group">
                        <input type="text" name="search" class="form-control" placeholder="Rechercher par véhicule, conducteur, département..." value="{{ request.GET.search }}">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="submit">Rechercher</button>
                            {% if request.GET.search %}
                                <a href="{% url 'fleet_app:kpi_distance' %}" class="btn btn-secondary">Réinitialiser</a>
                            {% endif %}
                        </div>
                    </div>
                </form>
                
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                    <table id="distanceTable" class="table table-striped table-hover">
                        <thead style="position: sticky; top: 0; background-color: #f8f9fa;">
                            <tr>
                                <th>Véhicule</th>
                                <th>Période</th>
                                <th>Km début</th>
                                <th>Km fin</th>
                                <th>Distance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for distance in distances %}
                            <tr>
                                <td>{{ distance.vehicule.marque }} {{ distance.vehicule.modele }} ({{ distance.vehicule.immatriculation }})</td>
                                <td>{{ distance.date_debut }} - {{ distance.date_fin }}</td>
                                <td>{{ distance.km_debut }}</td>
                                <td>{{ distance.km_fin }}</td>
                                <td>{{ distance.distance_parcourue }} km</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'fleet_app:distance_edit' distance.id %}" class="btn btn-warning" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-danger" title="Supprimer" onclick="confirmDelete('{% url 'fleet_app:distance_delete' distance.id %}', 'cette distance parcourue')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">Aucune donnée de distance disponible</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- Pagination -->
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if distances.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ distances.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for i in distances.paginator.page_range %}
                            {% if distances.number == i %}
                                <li class="page-item active"><a class="page-link" href="?page={{ i }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ i }}</a></li>
                            {% elif i > distances.number|add:'-3' and i < distances.number|add:'3' %}
                                <li class="page-item"><a class="page-link" href="?page={{ i }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ i }}</a></li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if distances.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ distances.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ distances.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                
                <!-- Pagination -->
                {% if distances.has_other_pages %}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if distances.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ distances.previous_page_number }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for num in distances.paginator.page_range %}
                            {% if distances.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > distances.number|add:'-3' and num < distances.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if distances.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ distances.next_page_number }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ distances.paginator.num_pages }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <button class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-file-export"></i> Exporter
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calcul automatique de la distance parcourue
        const kmDebutInput = document.getElementById('{{ form.km_debut.id_for_label }}');
        const kmFinInput = document.getElementById('{{ form.km_fin.id_for_label }}');
        const distanceParcourueInput = document.getElementById('{{ form.distance_parcourue.id_for_label }}');
        
        // Fonction pour formater les nombres avec séparateurs de milliers
        function formatNumber(number) {
            return new Intl.NumberFormat('fr-FR').format(number);
        }

        // Fonction simple pour calculer la distance
        function calculerDistance() {
            const kmDebut = parseInt(kmDebutInput.value) || 0;
            const kmFin = parseInt(kmFinInput.value) || 0;
            
            if (kmFin >= kmDebut) {
                distanceParcourueInput.value = kmFin - kmDebut;
            } else if (kmFin > 0 && kmDebut > 0) {
                // Afficher un message d'alerte si km_fin < km_debut
                alert('Attention : Le kilométrage final est inférieur au kilométrage initial.');
            }
        }
        
        // Ajouter les écouteurs d'événements simples
        kmDebutInput.addEventListener('input', calculerDistance);
        kmFinInput.addEventListener('input', calculerDistance);
        kmDebutInput.addEventListener('change', calculerDistance);
        kmFinInput.addEventListener('change', calculerDistance);
        
        // Récupérer le type de moteur du véhicule sélectionné
        const vehiculeSelect = document.getElementById('{{ form.vehicule.id_for_label }}');
        const limiteAnnuelleInput = document.getElementById('{{ form.limite_annuelle.id_for_label }}');
        
        // Fonction pour définir la limite annuelle en fonction du type de moteur
        function definirLimiteAnnuelle() {
            // Cette fonction nécessiterait un appel AJAX pour récupérer le type de moteur
            // Nous laissons cette logique côté serveur pour l'instant
        }
        
        vehiculeSelect.addEventListener('change', definirLimiteAnnuelle);
        // Données pour le graphique
        const labels = {{ labels|safe }};
        const data = {{ data|safe }};
        
        // Calcul des statistiques
        const totalDistance = data.reduce((a, b) => a + b, 0);
        const moyenneDistance = totalDistance / (data.length || 1);
        
        // Trouver le véhicule avec le plus de km
        let maxIndex = 0;
        for (let i = 1; i < data.length; i++) {
            if (data[i] > data[maxIndex]) {
                maxIndex = i;
            }
        }
        
        // Afficher les statistiques
        document.getElementById('distanceTotale').textContent = totalDistance.toLocaleString() + ' km';
        document.getElementById('moyenneParVehicule').textContent = Math.round(moyenneDistance).toLocaleString() + ' km';
        document.getElementById('vehiculePlusKm').textContent = labels[maxIndex] + ' (' + data[maxIndex].toLocaleString() + ' km)';
        
        // Calculer la moyenne mobile pour une courbe plus dynamique
        function calculerMoyenneMobile(data, periode = 2) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                let somme = 0;
                let count = 0;
                
                // Calculer la moyenne sur la période spécifiée
                for (let j = Math.max(0, i - periode); j <= Math.min(data.length - 1, i + periode); j++) {
                    somme += data[j];
                    count++;
                }
                
                result.push(somme / count);
            }
            return result;
        }
        
        // Calculer les données pour la courbe dynamique
        const courbeDynamiqueData = calculerMoyenneMobile(data);
        
        // Créer le graphique
        const ctx = document.getElementById('distancesChart').getContext('2d');
        const distancesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Distance totale (km)',
                        data: data,
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1,
                        order: 2,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    },
                    {
                        label: 'Courbe dynamique',
                        data: courbeDynamiqueData,
                        type: 'line',
                        fill: {
                            target: 'origin',
                            above: 'rgba(46, 204, 113, 0.2)'
                        },
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 7,
                        pointBackgroundColor: 'rgba(46, 204, 113, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        tension: 0.4,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1500,
                    easing: 'easeOutQuart'
                },
                animations: {
                    colors: {
                        type: 'color',
                        duration: 1000
                    },
                    y: {
                        from: 0
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Distance (km)',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            padding: 10
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                return value.toLocaleString() + ' km';
                            }
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.2)'
                        }
                    },
                    x: {
                        ticks: {
                            autoSkip: true,
                            maxRotation: 45,
                            minRotation: 45,
                            font: {
                                size: 10
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 10,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toLocaleString() + ' km';
                                }
                                return label;
                            },
                            footer: function(context) {
                                // Ajouter des informations supplémentaires
                                const value = context[0].parsed.y;
                                const moyenne = data.reduce((a, b) => a + b, 0) / data.length;
                                
                                if (value > moyenne * 1.5) {
                                    return 'Distance très élevée (+'+ Math.round((value/moyenne - 1) * 100) +'% vs moyenne)';
                                } else if (value > moyenne * 1.2) {
                                    return 'Distance élevée (+'+ Math.round((value/moyenne - 1) * 100) +'% vs moyenne)';
                                } else if (value < moyenne * 0.5) {
                                    return 'Distance très faible ('+ Math.round((value/moyenne) * 100) +'% de la moyenne)';
                                } else if (value < moyenne * 0.8) {
                                    return 'Distance faible ('+ Math.round((value/moyenne) * 100) +'% de la moyenne)';
                                } else {
                                    return 'Distance proche de la moyenne';
                                }
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        footerFont: {
                            size: 12,
                            style: 'italic'
                        },
                        padding: 12,
                        displayColors: true,
                        usePointStyle: true
                    }
                }
            }
        });
        
        // Fonction de recherche dans le tableau
        document.getElementById('searchDistance').addEventListener('keyup', function() {
            const searchText = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('tbody tr');
            
            tableRows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                if (rowText.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}
