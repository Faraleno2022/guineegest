{% extends 'fleet_app/base.html' %}
{% load static %}

{% block title %}Fiches de Bord Machine{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-truck me-2"></i>Fiches de Bord Machine</h5>
            <div>
                <a href="{% url 'fleet_app:fiche_bord_machine_add' %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus me-1"></i>Nouvelle fiche
                </a>
                <a href="{% url 'fleet_app:fiche_bord_machine_export' %}" class="btn btn-success btn-sm">
                    <i class="fas fa-file-excel me-1"></i>Exporter CSV
                </a>
            </div>
        </div>
        <div class="card-body">
            <!-- Recherche dynamique multi-critères -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <form method="get" class="row g-3 align-items-end" id="fbmSearchForm">
                        <div class="col-md-12">
                            <label for="q" class="form-label">Recherche</label>
                            <input type="text" class="form-control" id="q" name="q" value="{{ q }}" placeholder="Ex: 2025-08-01..2025-08-31 machine:D6 chauffeur:Kaba">
                            <small class="text-muted">Syntaxe: date_debut:YYYY-MM-DD, date_fin:YYYY-MM-DD, ou plage YYYY-MM-DD..YYYY-MM-DD, machine:XXX, chauffeur:XXX. Mots libres acceptés.</small>
                        </div>
                        <div class="col-12">
                            <a href="{% url 'fleet_app:fiche_bord_machine_list' %}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-times me-1"></i>Réinitialiser
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <div id="fbmResultsContainer">
                {% include 'fleet_app/entreprise/partials/fiche_bord_machine_list_partial.html' %}
            </div>

            <script>
            (function(){
                const form = document.getElementById('fbmSearchForm');
                const input = form ? form.querySelector('#q') : null;
                const container = document.getElementById('fbmResultsContainer');
                if (!form || !input || !container) return;
                let timer = null;
                function fetchAndRender(url){
                    fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
                        .then(r => r.text())
                        .then(html => { container.innerHTML = html; })
                        .catch(console.error);
                }
                function buildUrl(){
                    const params = new URLSearchParams(new FormData(form));
                    params.set('partial', '1');
                    return `${window.location.pathname}?${params.toString()}`;
                }
                function trigger(){ fetchAndRender(buildUrl()); }
                input.addEventListener('input', function(){
                    if (timer) clearTimeout(timer);
                    timer = setTimeout(trigger, 400);
                });
                input.addEventListener('change', trigger);
                container.addEventListener('click', function(e){
                    const a = e.target.closest('a.page-link');
                    if (!a) return;
                    e.preventDefault();
                    const url = new URL(a.href, window.location.origin);
                    url.searchParams.set('partial', '1');
                    fetchAndRender(url.toString());
                });
            })();
            </script>
        </div>
    </div>
</div>
{% endblock %}
