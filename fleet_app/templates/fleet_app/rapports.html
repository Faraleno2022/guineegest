{% extends 'fleet_app/base.html' %}

{% block title %}Rapports - Gestion de Parc Automobile{% endblock %}

{% block page_title %}Rapports et Analyses{% endblock %}

{% block content %}
<div class="row">
    <!-- Filtres et options d'exportation -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-filter me-2"></i> Filtres et options d'exportation
            </div>
            <div class="card-body">
                <form class="row g-3">
                    <div class="col-12 col-md-6 col-lg-3">
                        <label for="typeRapport" class="form-label">Type de rapport</label>
                        <select id="typeRapport" class="form-select">
                            <option value="global">Rapport global</option>
                            <option value="couts">Analyse des coûts</option>
                            <option value="utilisation">Taux d'utilisation</option>
                            <option value="carburant">Consommation de carburant</option>
                            <option value="maintenance">Maintenance et réparations</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <label for="periodeDebut" class="form-label">Période début</label>
                        <input type="date" class="form-control" id="periodeDebut">
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <label for="periodeFin" class="form-label">Période fin</label>
                        <input type="date" class="form-control" id="periodeFin">
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <label for="vehiculeSelect" class="form-label">Véhicule</label>
                        <select id="vehiculeSelect" class="form-select">
                            <option value="tous">Tous les véhicules</option>
                            {% for vehicule in vehicules %}
                            <option value="{{ vehicule.id_vehicule }}">{{ vehicule.marque }} {{ vehicule.modele }} ({{ vehicule.immatriculation }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <label for="formatExport" class="form-label">Format d'exportation</label>
                        <select id="formatExport" class="form-select">
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <label for="groupeBy" class="form-label">Grouper par</label>
                        <select id="groupeBy" class="form-select">
                            <option value="vehicule">Véhicule</option>
                            <option value="mois">Mois</option>
                            <option value="categorie">Catégorie</option>
                            <option value="marque">Marque</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <label for="comparerAvec" class="form-label">Comparer avec</label>
                        <select id="comparerAvec" class="form-select">
                            <option value="aucun">Aucune comparaison</option>
                            <option value="annee_precedente">Année précédente</option>
                            <option value="trimestre_precedent">Trimestre précédent</option>
                            <option value="objectifs">Objectifs</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" id="genererRapport">
                            <i class="fas fa-file-alt me-2"></i> Générer le rapport
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Aperçu du rapport -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                    <div>
                        <i class="fas fa-chart-line me-2"></i> Aperçu du rapport
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-outline-secondary" id="printReport">
                            <i class="fas fa-print me-1"></i> Imprimer
                        </button>
                        <button class="btn btn-sm btn-outline-primary" id="exportReport">
                            <i class="fas fa-file-export me-1"></i> Exporter
                        </button>
                        <button class="btn btn-sm btn-outline-success" id="shareReport">
                            <i class="fas fa-share-alt me-1"></i> Partager
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body" id="reportPreview">
                <!-- Contenu dynamique du rapport -->
                <div id="reportContent">
                    <div class="text-center py-5" id="reportPlaceholder">
                        <i class="fas fa-file-alt fa-4x mb-3 text-muted"></i>
                        <h4>Sélectionnez les critères et générez un rapport</h4>
                        <p class="text-muted">Utilisez les filtres ci-dessus pour personnaliser votre rapport</p>
                    </div>
                    
                    <!-- Ce contenu sera affiché après génération du rapport -->
                    <div id="generatedReport" style="display: none;">
                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <h4 id="reportTitle">Rapport global de la flotte</h4>
                                <p class="text-muted" id="reportPeriod">Période: 01/01/2025 - 30/06/2025</p>
                                <hr>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Graphique principal -->
                            <div class="col-12 col-lg-8 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-chart-bar me-2"></i> <span id="chartTitle">Évolution des coûts</span>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="mainChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Statistiques clés -->
                            <div class="col-12 col-lg-4 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-tachometer-alt me-2"></i> Indicateurs clés
                                    </div>
                                    <div class="card-body">
                                        <div class="stat-card">
                                            <i class="fas fa-money-bill"></i>
                                            <div class="stat-value" id="coutTotal">0 GNF</div>
                                            <div class="stat-label">Coût total</div>
                                        </div>
                                        <hr>
                                        <div class="stat-card">
                                            <i class="fas fa-gas-pump"></i>
                                            <div class="stat-value" id="consommationMoyenne">0 L/100km</div>
                                            <div class="stat-label">Consommation moyenne</div>
                                        </div>
                                        <hr>
                                        <div class="stat-card">
                                            <i class="fas fa-road"></i>
                                            <div class="stat-value" id="distanceTotale">0 km</div>
                                            <div class="stat-label">Distance totale</div>
                                        </div>
                                        <hr>
                                        <div class="stat-card">
                                            <i class="fas fa-tools"></i>
                                            <div class="stat-value" id="coutMaintenance">0 GNF</div>
                                            <div class="stat-label">Coût de maintenance</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Tableau de données -->
                            <div class="col-md-12 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-table me-2"></i> Données détaillées
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Véhicule</th>
                                                        <th>Distance (km)</th>
                                                        <th>Consommation (L/100km)</th>
                                                        <th>Coût carburant (GNF)</th>
                                                        <th>Coût maintenance (GNF)</th>
                                                        <th>Coût total (GNF)</th>
                                                        <th>Coût/km (GNF)</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="reportTableBody">
                                                    <!-- Données dynamiques -->
                                                </tbody>
                                                <tfoot>
                                                    <tr class="table-primary">
                                                        <th>Total</th>
                                                        <th id="totalDistance">0 km</th>
                                                        <th id="moyenneConsommation">0 L/100km</th>
                                                        <th id="totalCoutCarburant">0 GNF</th>
                                                        <th id="totalCoutMaintenance">0 GNF</th>
                                                        <th id="totalCoutGlobal">0 GNF</th>
                                                        <th id="moyenneCoutKm">0 GNF/km</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Graphiques complémentaires -->
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-chart-pie me-2"></i> Répartition des coûts
                                    </div>
                                    <div class="card-body">
                                        <canvas id="pieChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-chart-line me-2"></i> Tendances
                                    </div>
                                    <div class="card-body">
                                        <canvas id="lineChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Rapports enregistrés -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-save me-2"></i> Rapports enregistrés
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Nom du rapport</th>
                                <th>Type</th>
                                <th>Période</th>
                                <th>Date de création</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Rapport annuel 2024</td>
                                <td>Rapport global</td>
                                <td>01/01/2024 - 31/12/2024</td>
                                <td>15/01/2025</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewReport(this)" title="Voir le rapport">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="exportReport(this)" title="Exporter le rapport">
                                            <i class="fas fa-file-export"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteReport(this)" title="Supprimer le rapport">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Analyse des coûts T1 2025</td>
                                <td>Analyse des coûts</td>
                                <td>01/01/2025 - 31/03/2025</td>
                                <td>05/04/2025</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewReport(this)" title="Voir le rapport">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="exportReport(this)" title="Exporter le rapport">
                                            <i class="fas fa-file-export"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteReport(this)" title="Supprimer le rapport">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Consommation carburant S1 2025</td>
                                <td>Consommation de carburant</td>
                                <td>01/01/2025 - 30/06/2025</td>
                                <td>10/07/2025</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewReport(this)" title="Voir le rapport">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="exportReport(this)" title="Exporter le rapport">
                                            <i class="fas fa-file-export"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteReport(this)" title="Supprimer le rapport">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fonctions pour générer les graphiques et mettre à jour les indicateurs
        window.generateCharts = function(reportType) {
            // Effacer les graphiques existants
            if (window.reportCharts) {
                window.reportCharts.forEach(chart => chart.destroy());
            }
            window.reportCharts = [];
            
            // Générer différents graphiques selon le type de rapport
            if (reportType.includes('global')) {
                // Graphique global - vue d'ensemble
                const ctx1 = document.getElementById('chartOverview').getContext('2d');
                const overviewChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin'],
                        datasets: [{
                            label: 'Coûts (GNF)',
                            data: [45000000, 52000000, 48000000, 56000000, 61000000, 58000000],
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }, {
                            label: 'Distance (km)',
                            data: [2800, 3200, 2900, 3500, 3800, 3600],
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                window.reportCharts.push(overviewChart);
                
                // Graphique de disponibilité
                const ctx2 = document.getElementById('chartAvailability').getContext('2d');
                const availabilityChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin'],
                        datasets: [{
                            label: 'Disponibilité (%)',
                            data: [92, 94, 91, 95, 93, 96],
                            backgroundColor: 'rgba(153, 102, 255, 0.5)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 80,
                                max: 100
                            }
                        }
                    }
                });
                window.reportCharts.push(availabilityChart);
            } 
            else if (reportType.includes('coût')) {
                // Graphique des coûts par véhicule
                const ctx1 = document.getElementById('chartOverview').getContext('2d');
                const costsChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Véhicule 1', 'Véhicule 2', 'Véhicule 3', 'Véhicule 4', 'Véhicule 5'],
                        datasets: [{
                            label: 'Coûts de fonctionnement (GNF)',
                            data: [25000000, 32000000, 18000000, 29000000, 35000000],
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }, {
                            label: 'Coûts financiers (GNF)',
                            data: [18000000, 21000000, 15000000, 22000000, 19000000],
                            backgroundColor: 'rgba(255, 159, 64, 0.5)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                window.reportCharts.push(costsChart);
                
                // Graphique de répartition des coûts
                const ctx2 = document.getElementById('chartAvailability').getContext('2d');
                const costBreakdownChart = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: ['Carburant', 'Entretien', 'Assurance', 'Taxes', 'Autres'],
                        datasets: [{
                            data: [35, 25, 20, 15, 5],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
                window.reportCharts.push(costBreakdownChart);
            }
            else if (reportType.includes('carburant')) {
                // Graphique de consommation de carburant
                const ctx1 = document.getElementById('chartOverview').getContext('2d');
                const fuelChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Véhicule 1', 'Véhicule 2', 'Véhicule 3', 'Véhicule 4', 'Véhicule 5'],
                        datasets: [{
                            label: 'Consommation moyenne (L/100km)',
                            data: [7.2, 8.5, 6.8, 9.1, 5.9],
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                window.reportCharts.push(fuelChart);
                
                // Graphique d'évolution de la consommation
                const ctx2 = document.getElementById('chartAvailability').getContext('2d');
                const fuelTrendChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin'],
                        datasets: [{
                            label: 'Consommation moyenne (L/100km)',
                            data: [7.8, 7.6, 7.9, 7.5, 7.3, 7.2],
                            backgroundColor: 'rgba(255, 159, 64, 0.5)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
                window.reportCharts.push(fuelTrendChart);
            }
            else {
                // Graphique par défaut
                const ctx = document.getElementById('chartOverview').getContext('2d');
                const defaultChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin'],
                        datasets: [{
                            label: 'Données',
                            data: [12, 19, 3, 5, 2, 3],
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                window.reportCharts.push(defaultChart);
            }
        };
        
        window.updateKeyIndicators = function() {
            // Mettre à jour les indicateurs clés avec des valeurs simulées
            const indicators = {
                'kpi-distance': Math.floor(Math.random() * 5000) + 20000 + ' km',
                'kpi-cout': Math.floor(Math.random() * 100000000 + 300000000) + ' GNF',
                'kpi-consommation': (Math.random() * 2 + 6).toFixed(1) + ' L/100km',
                'kpi-disponibilite': (Math.random() * 10 + 85).toFixed(1) + '%',
                'kpi-incidents': Math.floor(Math.random() * 10) + ' incidents',
                'kpi-utilisation': (Math.random() * 20 + 70).toFixed(1) + '%'
            };
            
            // Mettre à jour les valeurs dans le DOM
            Object.keys(indicators).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerText = indicators[id];
                }
            });
        };
        
        // Gestion du bouton de génération de rapport
        document.getElementById('genererRapport').addEventListener('click', function() {
            // Cacher le placeholder et afficher le rapport généré
            document.getElementById('reportPlaceholder').style.display = 'none';
            document.getElementById('generatedReport').style.display = 'block';
            
            // Récupérer les valeurs des filtres
            const typeRapport = document.getElementById('typeRapport').value;
            const periodeDebut = document.getElementById('periodeDebut').value;
            const periodeFin = document.getElementById('periodeFin').value;
            
            // Mettre à jour le titre et la période du rapport
            document.getElementById('reportTitle').textContent = 
                document.getElementById('typeRapport').options[document.getElementById('typeRapport').selectedIndex].text;
            
            if (periodeDebut && periodeFin) {
                document.getElementById('reportPeriod').textContent = `Période: ${formatDate(periodeDebut)} - ${formatDate(periodeFin)}`;
            }
            
            // Générer des données fictives pour le tableau
            generateTableData();
            
            // Générer les graphiques
            generateCharts(typeRapport);
            
            // Mettre à jour les indicateurs clés avec des valeurs fictives
            updateKeyIndicators();
        });
        
        // Fonction pour formater la date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }
        
        // Fonction pour générer des données fictives pour le tableau
        function generateTableData() {
            const tableBody = document.getElementById('reportTableBody');
            tableBody.innerHTML = '';
            
            // Données fictives
            const vehicules = [
                {
                    nom: 'Renault Kangoo (AB-123-CD)',
                    distance: 15420,
                    consommation: 6.8,
                    coutCarburant: 1250.30,
                    coutMaintenance: 850.75,
                    coutTotal: 2101.05,
                    coutKm: 0.14
                },
                {
                    nom: 'Peugeot Partner (EF-456-GH)',
                    distance: 12850,
                    consommation: 7.2,
                    coutCarburant: 1102.40,
                    coutMaintenance: 720.30,
                    coutTotal: 1822.70,
                    coutKm: 0.15
                },
                {
                    nom: 'Citroën Berlingo (IJ-789-KL)',
                    distance: 18320,
                    consommation: 6.5,
                    coutCarburant: 1420.80,
                    coutMaintenance: 950.25,
                    coutTotal: 2371.05,
                    coutKm: 0.13
                }
            ];
            
            // Calcul des totaux
            let totalDistance = 0;
            let totalConsommation = 0;
            let totalCoutCarburant = 0;
            let totalCoutMaintenance = 0;
            let totalCoutGlobal = 0;
            
            // Ajouter les lignes au tableau
            vehicules.forEach(vehicule => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${vehicule.nom}</td>
                    <td>${vehicule.distance.toLocaleString()} km</td>
                    <td>${vehicule.consommation.toFixed(1)} L/100km</td>
                    <td>${vehicule.coutCarburant.toFixed(2)} €</td>
                    <td>${vehicule.coutMaintenance.toFixed(2)} €</td>
                    <td>${vehicule.coutTotal.toFixed(2)} €</td>
                    <td>${vehicule.coutKm.toFixed(2)} €/km</td>
                `;
                
                tableBody.appendChild(row);
                
                // Mise à jour des totaux
                totalDistance += vehicule.distance;
                totalConsommation += vehicule.consommation;
                totalCoutCarburant += vehicule.coutCarburant;
                totalCoutMaintenance += vehicule.coutMaintenance;
                totalCoutGlobal += vehicule.coutTotal;
            });
            
            // Mettre à jour les totaux dans le pied de tableau
            document.getElementById('totalDistance').textContent = totalDistance.toLocaleString() + ' km';
            document.getElementById('moyenneConsommation').textContent = (totalConsommation / vehicules.length).toFixed(1) + ' L/100km';
            document.getElementById('totalCoutCarburant').textContent = totalCoutCarburant.toLocaleString() + ' GNF';
            document.getElementById('totalCoutMaintenance').textContent = totalCoutMaintenance.toLocaleString() + ' GNF';
            document.getElementById('totalCoutGlobal').textContent = totalCoutGlobal.toLocaleString() + ' GNF';
            document.getElementById('moyenneCoutKm').textContent = Math.round(totalCoutGlobal / totalDistance).toLocaleString() + ' GNF/km';
        }
        
        // Fonction pour générer les graphiques
        function generateCharts(typeRapport) {
            // Graphique principal (bar chart)
            const mainCtx = document.getElementById('mainChart').getContext('2d');
            
            // Adapter le titre du graphique en fonction du type de rapport
            let chartTitle = 'Évolution des coûts';
            if (typeRapport === 'carburant') {
                chartTitle = 'Consommation de carburant';
            } else if (typeRapport === 'utilisation') {
                chartTitle = 'Taux d\'utilisation';
            }
            document.getElementById('chartTitle').textContent = chartTitle;
            
            // Données fictives pour le graphique principal
            const mainChart = new Chart(mainCtx, {
                type: 'bar',
                data: {
                    labels: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin'],
                    datasets: [{
                        label: 'Coûts totaux (GNF)',
                        data: [12500000, 9800000, 14200000, 11500000, 16800000, 14200000],
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Graphique en camembert (répartition des coûts)
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            const pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['Carburant', 'Maintenance', 'Assurance', 'Taxes', 'Amortissement'],
                    datasets: [{
                        data: [35, 25, 15, 10, 15],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(231, 76, 60, 0.7)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(155, 89, 182, 1)',
                            'rgba(241, 196, 15, 1)',
                            'rgba(231, 76, 60, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
            
            // Graphique en ligne (tendances)
            const lineCtx = document.getElementById('lineChart').getContext('2d');
            const lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin'],
                    datasets: [{
                        label: 'Coût/km (GNF)',
                        data: [1500, 1400, 1600, 1300, 1500, 1400],
                        borderColor: 'rgba(46, 204, 113, 1)',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Fonction pour mettre à jour les indicateurs clés
        function updateKeyIndicators() {
            document.getElementById('coutTotal').textContent = '6,294.80 €';
            document.getElementById('consommationMoyenne').textContent = '6.8 L/100km';
            document.getElementById('distanceTotale').textContent = '46,590 km';
            document.getElementById('coutMaintenance').textContent = '2,521.30 €';
        }
        
        // Gestion des boutons d'action sur le rapport
        document.getElementById('printReport').addEventListener('click', function() {
            printCurrentReport();
        });
        
        document.getElementById('exportReport').addEventListener('click', function() {
            exportCurrentReport();
        });
        
        document.getElementById('shareReport').addEventListener('click', function() {
            shareCurrentReport();
        });
        
        // Fonctions pour les boutons d'action des rapports enregistrés
        window.viewReport = function(element) {
            // Récupérer les informations du rapport depuis la ligne du tableau
            const row = element.closest('tr');
            const reportName = row.cells[0].innerText;
            const reportType = row.cells[1].innerText;
            const reportPeriod = row.cells[2].innerText;
            
            // Afficher le rapport dans la section d'aperçu
            document.getElementById('reportPlaceholder').style.display = 'none';
            document.getElementById('generatedReport').style.display = 'block';
            
            // Mettre à jour le titre et la période
            document.getElementById('reportTitle').innerText = reportName;
            document.getElementById('reportPeriod').innerText = 'Période: ' + reportPeriod;
            
            // Générer les graphiques en fonction du type de rapport
            generateCharts(reportType.toLowerCase());
            
            // Mettre à jour les indicateurs clés
            updateKeyIndicators();
            
            // Faire défiler jusqu'à l'aperçu du rapport
            document.querySelector('.card-header:contains("Aperçu du rapport")').scrollIntoView({ behavior: 'smooth' });
            
            // Afficher une notification de succès
            showToast('Rapport chargé avec succès', 'success');
        };
        
        window.exportReport = function(element) {
            // Récupérer les informations du rapport depuis la ligne du tableau
            const row = element.closest('tr');
            const reportName = row.cells[0].innerText;
            
            // Simuler l'exportation avec différents formats
            const formats = ['PDF', 'Excel', 'CSV'];
            const format = formats[Math.floor(Math.random() * formats.length)];
            
            // Afficher une notification de succès
            showToast(`Rapport "${reportName}" exporté au format ${format}`, 'success');
        };
        
        window.deleteReport = function(element) {
            // Récupérer les informations du rapport depuis la ligne du tableau
            const row = element.closest('tr');
            const reportName = row.cells[0].innerText;
            
            // Demander confirmation avant de supprimer
            if (confirm(`Êtes-vous sûr de vouloir supprimer le rapport "${reportName}" ?`)) {
                // Simuler la suppression en retirant la ligne du tableau
                row.remove();
                
                // Afficher une notification de succès
                showToast(`Rapport "${reportName}" supprimé avec succès`, 'success');
            }
        };
        
        // Fonctions pour les actions sur le rapport courant
        function printCurrentReport() {
            const reportTitle = document.getElementById('reportTitle').innerText;
            showToast(`Impression du rapport "${reportTitle}" en cours...`, 'info');
            window.print();
        }
        
        function exportCurrentReport() {
            const reportTitle = document.getElementById('reportTitle').innerText;
            const format = document.getElementById('formatExport').value.toUpperCase();
            showToast(`Rapport "${reportTitle}" exporté au format ${format}`, 'success');
        }
        
        function shareCurrentReport() {
            const reportTitle = document.getElementById('reportTitle').innerText;
            showToast(`Lien de partage du rapport "${reportTitle}" copié dans le presse-papier`, 'success');
        }
        
        // Fonction pour afficher des notifications toast
        function showToast(message, type = 'info') {
            // Créer l'élément toast s'il n'existe pas déjà
            if (!document.getElementById('toast-container')) {
                const toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.position = 'fixed';
                toastContainer.style.top = '20px';
                toastContainer.style.right = '20px';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            // Créer le toast
            const toast = document.createElement('div');
            toast.className = `toast bg-${type} text-white`;
            toast.style.minWidth = '250px';
            toast.innerHTML = `
                <div class="toast-header bg-${type} text-white">
                    <strong class="me-auto">Notification</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            // Ajouter le toast au conteneur
            document.getElementById('toast-container').appendChild(toast);
            
            // Initialiser le toast avec Bootstrap
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();
            
            // Supprimer le toast après qu'il soit caché
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }
    });
</script>
{% endblock %}
