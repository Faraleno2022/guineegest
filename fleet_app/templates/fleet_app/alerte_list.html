{% extends 'fleet_app/base.html' %}

{% block title %}Alertes - Gestion de Parc Automobile{% endblock %}

{% block page_title %}Alertes{% endblock %}

{% block content %}
<!-- Zone de recherche dynamique -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-search"></i> Recherche Dynamique des Alertes
                <button class="btn btn-sm btn-dark float-end" type="button" id="toggleAlertesSearch">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            <div class="card-body" id="alertesSearchPanel">
                <form id="alertesSearchForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Recherche générale</label>
                            <input type="text" class="form-control" id="search_text" name="search_text" 
                                   placeholder="Titre, description, type..." value="{{ search_text }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Niveau d'urgence</label>
                            <select class="form-select" id="search_niveau" name="search_niveau">
                                <option value="">Tous</option>
                                {% for value, label in niveaux_urgence %}
                                <option value="{{ value }}" {% if search_niveau == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Véhicule</label>
                            <input type="text" class="form-control" id="search_vehicule" name="search_vehicule" 
                                   placeholder="Immatriculation, marque..." value="{{ search_vehicule }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date min</label>
                            <input type="date" class="form-control" id="date_creation_min" name="date_creation_min" value="{{ date_creation_min }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date max</label>
                            <input type="date" class="form-control" id="date_creation_max" name="date_creation_max" value="{{ date_creation_max }}">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAlertesSearch">
                                <i class="fas fa-times"></i> Effacer les filtres
                            </button>
                            <div class="float-end">
                                <div id="alertesLoadingSpinner" class="d-none">
                                    <div class="spinner-border spinner-border-sm text-warning" role="status">
                                        <span class="visually-hidden">Recherche...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-bell me-2"></i> Alertes actives
            <span class="badge bg-danger ms-2" id="activesCount">{{ active_count }}</span>
        </div>
        <div>
            <a href="{% url 'fleet_app:alerte_nouvelle' %}" class="btn btn-sm btn-primary">
                <i class="fas fa-plus"></i> Nouvelle alerte
            </a>
        </div>
    </div>
    <div class="card-body">
        <div class="list-group" id="alertesActivesContainer">
            {% include 'fleet_app/alertes/alertes_actives_rows.html' with alertes=alertes %}
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-history me-2"></i> Historique des alertes résolues
            <span class="badge bg-secondary ms-2" id="resoluesCount">{{ resolved_count }}</span>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Véhicule</th>
                        <th>Niveau</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="alertesResoluesContainer">
                    {% include 'fleet_app/alertes/alertes_resolues_rows.html' with alertes=alertes_historique %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('alertesSearchForm');
    const searchInputs = searchForm.querySelectorAll('input, select');
    const loadingSpinner = document.getElementById('alertesLoadingSpinner');
    const activesContainer = document.getElementById('alertesActivesContainer');
    const resoluesContainer = document.getElementById('alertesResoluesContainer');
    const activesCount = document.getElementById('activesCount');
    const resoluesCount = document.getElementById('resoluesCount');
    const toggleSearch = document.getElementById('toggleAlertesSearch');
    const searchPanel = document.getElementById('alertesSearchPanel');
    const clearSearch = document.getElementById('clearAlertesSearch');
    
    let searchTimeout;
    
    // Toggle du panneau de recherche
    toggleSearch.addEventListener('click', function() {
        if (searchPanel.style.display === 'none') {
            searchPanel.style.display = 'block';
            toggleSearch.innerHTML = '<i class="fas fa-chevron-up"></i>';
        } else {
            searchPanel.style.display = 'none';
            toggleSearch.innerHTML = '<i class="fas fa-chevron-down"></i>';
        }
    });
    
    // Effacer la recherche
    clearSearch.addEventListener('click', function() {
        searchInputs.forEach(input => {
            input.value = '';
        });
        performSearch('actives');
        performSearch('resolues');
    });
    
    // Recherche en temps réel
    searchInputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch('actives');
                performSearch('resolues');
            }, 300);
        });
        
        input.addEventListener('change', function() {
            clearTimeout(searchTimeout);
            performSearch('actives');
            performSearch('resolues');
        });
    });
    
    function performSearch(section, page = 1) {
        loadingSpinner.classList.remove('d-none');
        
        const formData = new FormData(searchForm);
        const params = new URLSearchParams(formData);
        params.append('section', section);
        params.append('page', page);
        
        fetch('{% url "fleet_app:alerte_search_ajax" %}?' + params.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (section === 'actives') {
                activesContainer.innerHTML = data.html;
                activesCount.textContent = data.count;
                attachActionButtons();
            } else {
                resoluesContainer.innerHTML = data.html;
                resoluesCount.textContent = data.count;
                attachHistoryButtons();
            }
            
            loadingSpinner.classList.add('d-none');
        })
        .catch(error => {
            console.error('Erreur lors de la recherche:', error);
            loadingSpinner.classList.add('d-none');
        });
    }
    
    // Fonction pour obtenir le cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Fonction pour afficher un toast
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
        return container;
    }
    
    // Fonction pour attacher les event listeners aux boutons d'action des alertes actives
    function attachActionButtons() {
        // Boutons "Résoudre"
        document.querySelectorAll('.btn-resoudre').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const alerteId = this.getAttribute('data-id');
                const alerteRow = this.closest('.list-group-item');
                
                if (confirm('Marquer cette alerte comme résolue ?')) {
                    fetch(`{% url 'fleet_app:alerte_resoudre' 0 %}`.replace('0', alerteId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({csrfmiddlewaretoken: getCookie('csrftoken')})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alerteRow.remove();
                            showToast('Alerte marquée comme résolue.', 'success');
                            performSearch('actives');
                            performSearch('resolues');
                        } else {
                            throw new Error('Opération échouée');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showToast(`Erreur: ${error.message}`, 'danger');
                    });
                }
            });
        });
        
        // Boutons "Ignorer"
        document.querySelectorAll('.btn-ignorer').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const alerteId = this.getAttribute('data-id');
                const alerteRow = this.closest('.list-group-item');
                
                if (confirm('Ignorer cette alerte ?')) {
                    fetch(`{% url 'fleet_app:alerte_ignorer' 0 %}`.replace('0', alerteId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({csrfmiddlewaretoken: getCookie('csrftoken')})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alerteRow.remove();
                            showToast('Alerte ignorée.', 'info');
                            performSearch('actives');
                            performSearch('resolues');
                        } else {
                            throw new Error('Opération échouée');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showToast(`Erreur: ${error.message}`, 'danger');
                    });
                }
            });
        });
        
        // Boutons "Supprimer"
        document.querySelectorAll('.btn-supprimer').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const alerteId = this.getAttribute('data-id');
                const alerteRow = this.closest('.list-group-item');
                
                if (confirm('Êtes-vous sûr de vouloir supprimer cette alerte ?')) {
                    fetch(`{% url 'fleet_app:alerte_supprimer' 0 %}`.replace('0', alerteId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({csrfmiddlewaretoken: getCookie('csrftoken')})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alerteRow.remove();
                            showToast('Alerte supprimée.', 'danger');
                            performSearch('actives');
                        } else {
                            throw new Error('Opération échouée');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showToast(`Erreur: ${error.message}`, 'danger');
                    });
                }
            });
        });
    }
    
    // Fonction pour attacher les event listeners aux boutons de l'historique
    function attachHistoryButtons() {
        // Boutons "Supprimer" dans l'historique
        document.querySelectorAll('.btn-supprimer-historique').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const alerteId = this.getAttribute('data-id');
                const alerteRow = this.closest('tr');
                
                if (confirm('Êtes-vous sûr de vouloir supprimer définitivement cette alerte de l\'historique ?')) {
                    fetch(`{% url 'fleet_app:alerte_supprimer' 0 %}`.replace('0', alerteId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({csrfmiddlewaretoken: getCookie('csrftoken')})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alerteRow.remove();
                            showToast(`L'alerte a été supprimée de l'historique.`, 'danger');
                            performSearch('resolues');
                        } else {
                            throw new Error('Opération échouée');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showToast(`Erreur: ${error.message}`, 'danger');
                    });
                }
            });
        });
        
        // Boutons "Détails" dans l'historique
        document.querySelectorAll('.btn-details').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const alerteId = this.getAttribute('data-id');
                const alerteRow = this.closest('tr');
                const alerteType = alerteRow.cells[1].textContent.trim();
                const vehicule = alerteRow.cells[2].textContent.trim();
                const niveau = alerteRow.cells[3].textContent.trim();
                const statut = alerteRow.cells[4].textContent.trim();
                
                // Créer une boîte de dialogue modale pour afficher les détails
                const modalHtml = `
                <div class="modal fade" id="alerteDetailsModal" tabindex="-1" aria-labelledby="alerteDetailsModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="alerteDetailsModalLabel">Détails de l'alerte</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <table class="table">
                                    <tr>
                                        <th>Type d'alerte:</th>
                                        <td>${alerteType}</td>
                                    </tr>
                                    <tr>
                                        <th>Véhicule:</th>
                                        <td>${vehicule}</td>
                                    </tr>
                                    <tr>
                                        <th>Niveau d'urgence:</th>
                                        <td>${niveau}</td>
                                    </tr>
                                    <tr>
                                        <th>Statut:</th>
                                        <td>${statut}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                
                // Ajouter la modale au DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Afficher la modale
                const modal = new bootstrap.Modal(document.getElementById('alerteDetailsModal'));
                modal.show();
                
                // Nettoyer la modale après sa fermeture
                document.getElementById('alerteDetailsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            });
        });
    }
    
    // Attacher les event listeners initiaux
    attachActionButtons();
    attachHistoryButtons();
});
</script>
{% endblock %}
