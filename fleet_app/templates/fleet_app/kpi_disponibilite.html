{% extends 'fleet_app/base.html' %}

{% block title %}KPI Disponibilité - Gestion de Parc Automobile{% endblock %}

{% block page_title %}KPI Disponibilité des Véhicules{% endblock %}

{% block content %}
<div class="row">
    <!-- Formulaire d'ajout -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header {% if edit_mode %}bg-warning{% else %}bg-primary{% endif %} text-white d-flex justify-content-between align-items-center">
                <div>
                    {% if edit_mode %}
                    <i class="fas fa-edit me-2"></i> <strong>Modifier la période de disponibilité</strong>
                    {% else %}
                    <i class="fas fa-plus-circle me-2"></i> <strong>Ajouter une période de disponibilité</strong>
                    {% endif %}
                </div>
                <div>
                    <span class="badge bg-light text-dark">Formulaire de saisie</span>
                </div>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.vehicule.id_for_label }}" class="form-label">Véhicule</label>
                            {{ form.vehicule }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.date_debut.id_for_label }}" class="form-label">Date de début</label>
                            {{ form.date_debut }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.date_fin.id_for_label }}" class="form-label">Date de fin</label>
                            {{ form.date_fin }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.heures_disponibles.id_for_label }}" class="form-label">Heures disponibles</label>
                            {{ form.heures_disponibles }}
                            <small id="heuresDispoHelp" class="form-text text-muted"></small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.heures_totales.id_for_label }}" class="form-label">Heures totales</label>
                            {{ form.heures_totales }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.disponibilite_pourcentage.id_for_label }}" class="form-label">Disponibilité (%)</label>
                            {{ form.disponibilite_pourcentage }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="{{ form.raison_indisponibilite.id_for_label }}" class="form-label">Raison d'indisponibilité</label>
                            {{ form.raison_indisponibilite }}
                        </div>
                    </div>
                    <!-- Récapitulatif dynamique -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-secondary" id="recapDisponibilite" style="display: none;">
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <div><strong>Période:</strong> <span id="recapPeriodeJours">0</span> jours</div>
                                    <div><strong>Heures totales:</strong> <span id="recapHeuresTotales">0</span> h</div>
                                    <div><strong>Heures disponibles:</strong> <span id="recapHeuresDispo">0</span> h</div>
                                    <div><strong>Disponibilité:</strong> <span id="recapDispoPct">0</span>%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" id="resetDisponibilite" class="btn btn-outline-secondary">
                            <i class="fas fa-undo"></i> Réinitialiser
                        </button>
                        {% if edit_mode %}
                        <a href="{% url 'fleet_app:kpi_disponibilite' %}" class="btn btn-secondary me-2">
                            <i class="fas fa-times me-2"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save me-2"></i> Mettre à jour
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i> Enregistrer
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Graphique des disponibilités moyennes -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-chart-bar me-2"></i> Taux de disponibilité par véhicule (%)
                </div>
                <div>
                    {% include 'fleet_app/includes/period_filter.html' %}
                </div>
            </div>
            <div class="card-body" style="height: 250px;">
                <canvas id="disponibiliteParVehiculeChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Graphique principal de disponibilité -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i> Graphique de disponibilité des véhicules
            </div>
            <div class="card-body" style="height: 400px;">
                <canvas id="disponibiliteGlobalChart" height="350"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Statistiques de disponibilité -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-tachometer-alt me-2"></i> Statistiques globales
            </div>
            <div class="card-body">
                <div class="stat-card">
                    <i class="fas fa-check-circle"></i>
                    <div id="disponibiliteMoyenne" class="stat-value">{{ disponibilite_moyenne|floatformat:1 }}%</div>
                    <div class="stat-label">Disponibilité moyenne (%)</div>
                </div>
                <hr>
                <div class="stat-card">
                    <i class="fas fa-trophy"></i>
                    <div id="vehiculePlusDisponible" class="stat-value">{{ vehicule_plus_disponible|default:"N/A" }}</div>
                    <div class="stat-label">Véhicule le plus disponible</div>
                </div>
                <hr>
                <div class="stat-card">
                    <i class="fas fa-tools"></i>
                    <div id="vehiculeMoinsDisponible" class="stat-value">{{ vehicule_moins_disponible|default:"N/A" }}</div>
                    <div class="stat-label">Véhicule le moins disponible</div>
                </div>
            </div>
        </div>
        
        <!-- Répartition par catégorie -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i> Disponibilité par catégorie
            </div>
            <div class="card-body" style="height: 180px;">
                <canvas id="disponibiliteCategorieChart" height="150"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Tableau des disponibilités -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-list me-2"></i> Détail des disponibilités
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'fleet_app:export_kpi_disponibilite_csv' %}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-file-csv me-1"></i> CSV
                    </a>
                    <a href="{% url 'fleet_app:export_kpi_disponibilite_pdf' %}?period={{ request.GET.period }}&start={{ request.GET.start }}&end={{ request.GET.end }}" class="btn btn-sm btn-danger">
                        <i class="fas fa-file-pdf me-1"></i> PDF (serveur)
                    </a>
                    <button type="button" class="btn btn-sm btn-success" onclick="exportTableToExcel('disponibiliteTable', 'Disponibilite_Vehicules')">
                        <i class="fas fa-file-excel me-1"></i> Excel
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="exportTableToPDF('disponibiliteTable', 'Disponibilite_Vehicules')">
                        <i class="fas fa-file-pdf me-1"></i> PDF
                    </button>
                    <input type="text" id="searchDisponibilite" class="form-control form-control-sm" placeholder="Rechercher...">
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                    <table id="disponibiliteTable" class="table table-striped table-hover">
                        <thead style="position: sticky; top: 0; background-color: #f8f9fa;">
                            <tr>
                                <th>Véhicule</th>
                                <th>Période</th>
                                <th>Heures dispo / totales</th>
                                <th>Raison d'indisponibilité</th>
                                <th>Disponibilité (%)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dispo in disponibilites %}
                            <tr>
                                <td>{{ dispo.vehicule.marque }} {{ dispo.vehicule.modele }} ({{ dispo.vehicule.immatriculation }})</td>
                                <td>{{ dispo.date_debut|date:"d/m/Y" }} - {{ dispo.date_fin|date:"d/m/Y" }}</td>
                                <td>{{ dispo.heures_disponibles }} / {{ dispo.heures_totales }}</td>
                                <td>{{ dispo.raison_indisponibilite|truncatechars:50 }}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar {% if dispo.disponibilite_pourcentage >= 90 %}bg-success{% elif dispo.disponibilite_pourcentage >= 75 %}bg-info{% elif dispo.disponibilite_pourcentage >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                            role="progressbar" 
                                            style="width: {{ dispo.disponibilite_pourcentage }}%;" 
                                            aria-valuenow="{{ dispo.disponibilite_pourcentage }}" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">
                                            {{ dispo.disponibilite_pourcentage|floatformat:1 }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'fleet_app:disponibilite_edit' dispo.id %}" class="btn btn-warning" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-danger" title="Supprimer" onclick="confirmDelete('{% url 'fleet_app:disponibilite_delete' dispo.id %}', 'cette période de disponibilité')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">Aucune donnée de disponibilité disponible</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if disponibilites.has_other_pages %}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if disponibilites.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ disponibilites.previous_page_number }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for num in disponibilites.paginator.page_range %}
                            {% if disponibilites.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > disponibilites.number|add:'-3' and num < disponibilites.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if disponibilites.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ disponibilites.next_page_number }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ disponibilites.paginator.num_pages }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <a href="#" class="btn btn-sm btn-primary" onclick="scrollToTop()">
                    <i class="fas fa-plus"></i> Ajouter une période
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
    document.addEventListener('DOMContentLoaded', function() {
        // Débogage des données
        console.log('Labels:', {{ labels|safe }});
        console.log('Data:', {{ data|safe }});
        
        // Données pour le graphique
        const labels = {{ labels|safe }};
        const data = {{ data|safe }};
        
        // Calcul des statistiques
        const disponibiliteMoyenne = data.reduce((a, b) => a + b, 0) / (data.length || 1);
        
        // Trouver le véhicule le plus disponible
        let maxIndex = 0;
        for (let i = 1; i < data.length; i++) {
            if (data[i] > data[maxIndex]) {
                maxIndex = i;
            }
        }
        
        // Trouver le véhicule le moins disponible
        let minIndex = 0;
        for (let i = 1; i < data.length; i++) {
            if (data[i] < data[minIndex]) {
                minIndex = i;
            }
        }
        
        // Afficher les statistiques
        document.getElementById('disponibiliteMoyenne').textContent = disponibiliteMoyenne.toFixed(1) + '%';
        document.getElementById('vehiculePlusDisponible').textContent = labels[maxIndex] + ' (' + data[maxIndex].toFixed(1) + '%)';
        document.getElementById('vehiculeMoinsDisponible').textContent = labels[minIndex] + ' (' + data[minIndex].toFixed(1) + '%)';
        
        // Fonction pour animer la courbe dynamique
        function animerCourbeDynamique() {
            // Cette fonction sera appelée par Chart.js pour l'animation
        }
        
        // Créer un dégradé de couleurs pour les barres en fonction du taux de disponibilité
        const backgroundColors = data.map(value => {
            if (value >= 90) return 'rgba(46, 204, 113, 0.7)'; // Vert
            if (value >= 75) return 'rgba(52, 152, 219, 0.7)'; // Bleu
            if (value >= 50) return 'rgba(241, 196, 15, 0.7)'; // Jaune
            return 'rgba(231, 76, 60, 0.7)'; // Rouge
        });
        
        const borderColors = data.map(value => {
            if (value >= 90) return 'rgba(46, 204, 113, 1)'; // Vert
            if (value >= 75) return 'rgba(52, 152, 219, 1)'; // Bleu
            if (value >= 50) return 'rgba(241, 196, 15, 1)'; // Jaune
            return 'rgba(231, 76, 60, 1)'; // Rouge
        });
        
        // Vérifier si nous avons des données pour les graphiques
        if (labels.length === 0 || data.length === 0) {
            console.warn('Aucune donnée disponible pour les graphiques');
            // Ajouter des données factices pour le développement
            labels.push('Aucune donnée');
            data.push(0);
        }
        
        // Créer le graphique de disponibilité par véhicule
        const ctxParVehicule = document.getElementById('disponibiliteParVehiculeChart').getContext('2d');
        const disponibiliteParVehiculeChart = new Chart(ctxParVehicule, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Taux de disponibilité (%)',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    },
                    {
                        label: 'Courbe dynamique',
                        data: data,
                        type: 'line',
                        fill: {
                            target: 'origin',
                            above: 'rgba(75, 192, 192, 0.2)',
                        },
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.4,
                        cubicInterpolationMode: 'monotone',
                        spanGaps: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 2000,
                    easing: 'easeOutQuart',
                    delay: function(context) {
                        // Ajoute un délai progressif pour chaque barre
                        return context.dataIndex * 100;
                    },
                    loop: false
                },
                transitions: {
                    active: {
                        animation: {
                            duration: 400
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Disponibilité (%)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.3)'
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 90,
                            minRotation: 45
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                                return label;
                            },
                            title: function(context) {
                                return context[0].label;
                            },
                            footer: function(context) {
                                // Ajouter des informations supplémentaires
                                if (context[0].parsed.y >= 90) {
                                    return 'Excellente disponibilité';
                                } else if (context[0].parsed.y >= 75) {
                                    return 'Bonne disponibilité';
                                } else if (context[0].parsed.y >= 50) {
                                    return 'Disponibilité moyenne';
                                } else {
                                    return 'Disponibilité faible';
                                }
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        footerFont: {
                            style: 'italic',
                            size: 12
                        },
                        padding: 10,
                        displayColors: true,
                        usePointStyle: true
                    }
                }
            }
        });
        
        // Fonction de recherche dans le tableau
        document.getElementById('searchDisponibilite').addEventListener('keyup', function() {
            const searchText = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('tbody tr');
            
            tableRows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                if (rowText.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Créer le graphique global de disponibilité des véhicules
        const ctxGlobal = document.getElementById('disponibiliteGlobalChart').getContext('2d');
        const disponibiliteGlobalChart = new Chart(ctxGlobal, {
            type: 'doughnut',
            data: {
                labels: ['Disponible', 'Indisponible'],
                datasets: [{
                    data: [disponibiliteMoyenne, 100 - disponibiliteMoyenne],
                    backgroundColor: [
                        'rgba(46, 204, 113, 0.8)',
                        'rgba(231, 76, 60, 0.8)'
                    ],
                    borderColor: [
                        'rgba(46, 204, 113, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1500
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 14
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Disponibilité globale des véhicules',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.raw.toFixed(1) + '%';
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 10
                    }
                }
            }
        });
        
        // Auto-calcul heures totales et disponibilité (%) dans le formulaire
        const dateDebutInput = document.getElementById('{{ form.date_debut.id_for_label }}');
        const dateFinInput = document.getElementById('{{ form.date_fin.id_for_label }}');
        const heuresDispoInput = document.getElementById('{{ form.heures_disponibles.id_for_label }}');
        const heuresTotalesInput = document.getElementById('{{ form.heures_totales.id_for_label }}');
        const dispoPctInput = document.getElementById('{{ form.disponibilite_pourcentage.id_for_label }}');

        function parseDate(value) {
            // value is yyyy-mm-dd
            if (!value) return null;
            const [y, m, d] = value.split('-').map(Number);
            if (!y || !m || !d) return null;
            // Use UTC to avoid timezone issues
            return new Date(Date.UTC(y, m - 1, d));
        }

        function calcHeuresTotales() {
            const d1 = parseDate(dateDebutInput.value);
            const d2 = parseDate(dateFinInput.value);
            if (d1 && d2) {
                const diffDays = Math.floor((d2 - d1) / (1000*60*60*24)) + 1; // inclusif
                if (diffDays >= 0) {
                    const heuresTotales = diffDays * 24;
                    heuresTotalesInput.value = heuresTotales;
                    dateDebutInput.classList.remove('is-invalid');
                    dateFinInput.classList.remove('is-invalid');
                    dateDebutInput.classList.add('is-valid');
                    dateFinInput.classList.add('is-valid');
                    // Update recap
                    const recap = document.getElementById('recapDisponibilite');
                    const recapJours = document.getElementById('recapPeriodeJours');
                    recap.style.display = '';
                    recapJours.textContent = diffDays;
                    return heuresTotales;
                } else {
                    dateDebutInput.classList.add('is-invalid');
                    dateFinInput.classList.add('is-invalid');
                    return 0;
                }
            }
            return 0;
        }

        function calcDispoPourcentage() {
            const heuresTotales = calcHeuresTotales();
            let heuresDispo = parseFloat(heuresDispoInput.value) || 0;
            if (heuresTotales > 0 && heuresDispo >= 0) {
                const help = document.getElementById('heuresDispoHelp');
                help.textContent = '';
                if (heuresDispo > heuresTotales) {
                    heuresDispo = heuresTotales;
                    heuresDispoInput.value = heuresTotales;
                    help.textContent = "Les heures disponibles ont été ajustées au maximum possible (heures totales).";
                }
                let pct = (heuresDispo * 100) / heuresTotales;
                if (pct < 0) pct = 0; if (pct > 100) pct = 100;
                dispoPctInput.value = pct.toFixed(2);
                // Update recap values
                const recap = document.getElementById('recapDisponibilite');
                const recapHeuresTotales = document.getElementById('recapHeuresTotales');
                const recapHeuresDispo = document.getElementById('recapHeuresDispo');
                const recapDispoPct = document.getElementById('recapDispoPct');
                recap.style.display = '';
                recapHeuresTotales.textContent = heuresTotales;
                recapHeuresDispo.textContent = heuresDispo;
                recapDispoPct.textContent = pct.toFixed(2);
            } else {
                dispoPctInput.value = '';
                // Hide recap if incomplete
                const recap = document.getElementById('recapDisponibilite');
                recap.style.display = 'none';
            }
        }

        if (dateDebutInput && dateFinInput && heuresDispoInput) {
            dateDebutInput.addEventListener('change', () => { calcHeuresTotales(); calcDispoPourcentage(); });
            dateFinInput.addEventListener('change', () => { calcHeuresTotales(); calcDispoPourcentage(); });
            heuresDispoInput.addEventListener('input', calcDispoPourcentage);
        }

        // S'assurer que les valeurs sont à jour avant soumission
        const dispoForm = dateDebutInput ? dateDebutInput.closest('form') : null;
        if (dispoForm) {
            dispoForm.addEventListener('submit', function(e) {
                const d1 = parseDate(dateDebutInput.value);
                const d2 = parseDate(dateFinInput.value);
                if (d1 && d2 && d2 < d1) {
                    e.preventDefault();
                    if (typeof showToast === 'function') {
                        showToast('danger', 'La date de fin doit être postérieure ou égale à la date de début.');
                    } else {
                        alert('La date de fin doit être postérieure ou égale à la date de début.');
                    }
                    dateDebutInput.classList.add('is-invalid');
                    dateFinInput.classList.add('is-invalid');
                    return false;
                }
                calcDispoPourcentage();
            });
        }

        // Bouton Réinitialiser
        const resetBtn = document.getElementById('resetDisponibilite');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                // Clear inputs
                if (dateDebutInput) dateDebutInput.value = '';
                if (dateFinInput) dateFinInput.value = '';
                if (heuresDispoInput) heuresDispoInput.value = '';
                if (heuresTotalesInput) heuresTotalesInput.value = '';
                if (dispoPctInput) dispoPctInput.value = '';
                const help = document.getElementById('heuresDispoHelp');
                if (help) help.textContent = '';

                // Remove validation classes
                [dateDebutInput, dateFinInput, heuresDispoInput].forEach(el => {
                    if (!el) return;
                    el.classList.remove('is-valid');
                    el.classList.remove('is-invalid');
                });

                // Hide recap
                const recap = document.getElementById('recapDisponibilite');
                if (recap) recap.style.display = 'none';
            });
        }

        // Créer le graphique de disponibilité par catégorie
        const ctxCategorie = document.getElementById('disponibiliteCategorieChart').getContext('2d');
        const disponibiliteCategorieChart = new Chart(ctxCategorie, {
            type: 'polarArea',
            data: {
                labels: ['Véhicules légers', 'Utilitaires', 'Poids lourds', 'Spéciaux'],
                datasets: [{
                    data: [85.5, 75.3, 68.6, 79.2], // Données de disponibilité par catégorie
                    backgroundColor: [
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(231, 76, 60, 0.7)'
                    ],
                    borderColor: [
                        'rgba(46, 204, 113, 1)',
                        'rgba(52, 152, 219, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 2,
                    hoverBorderWidth: 4,
                    hoverBackgroundColor: [
                        'rgba(46, 204, 113, 0.9)',
                        'rgba(52, 152, 219, 0.9)',
                        'rgba(241, 196, 15, 0.9)',
                        'rgba(231, 76, 60, 0.9)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeOutQuart'
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            backdropColor: 'rgba(255, 255, 255, 0.8)'
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.3)'
                        },
                        angleLines: {
                            color: 'rgba(200, 200, 200, 0.3)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
