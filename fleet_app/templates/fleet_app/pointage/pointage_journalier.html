{% extends 'fleet_app/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Pointage Journalier - {{ mois_nom }} {{ annee }}{% endblock %}

{% block extra_css %}
<style>
    .pointage-table {
        font-size: 0.85rem;
    }
    
    .pointage-cell {
        min-width: 35px;
        text-align: center;
        padding: 2px !important;
        cursor: pointer;
        border: 1px solid #dee2e6;
    }
    
    .pointage-cell:hover {
        background-color: #f8f9fa;
    }
    
    .pointage-cell.disabled {
        background-color: #f8f9fa;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    /* Colonnes des informations employés */
    .matricule-col {
        min-width: 80px;
        text-align: center;
        padding: 8px !important;
        vertical-align: middle;
    }
    
    .nom-col {
        min-width: 150px;
        padding: 8px !important;
        vertical-align: middle;
        font-weight: 500;
    }
    
    .poste-col {
        min-width: 120px;
        padding: 8px !important;
        vertical-align: middle;
    }
    
    .date-col {
        min-width: 90px;
        text-align: center;
        padding: 8px !important;
        vertical-align: middle;
    }
    
    .salaire-col {
        min-width: 100px;
        text-align: right;
        padding: 8px !important;
        vertical-align: middle;
    }
    
    .tel-col {
        min-width: 100px;
        text-align: center;
        padding: 8px !important;
        vertical-align: middle;
    }
    
    /* Style des badges matricule */
    .matricule-col .badge {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    
    /* Style du texte dans les colonnes */
    .poste-col small,
    .date-col small,
    .salaire-col small,
    .tel-col small {
        font-size: 0.8rem;
        color: #495057;
    }
    
    .jour-header {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        min-width: 35px;
        font-size: 0.75rem;
    }
    
    /* Couleurs uniques pour chaque statut */
    .statut-P-Am { background-color: #d4edda; color: #155724; font-weight: bold; } /* Vert clair - Présent matin */
    .statut-P-Pm { background-color: #b3d9ff; color: #0056b3; font-weight: bold; } /* Bleu clair - Présent après-midi */
    .statut-P-dim-Am { background-color: #fff3cd; color: #856404; font-weight: bold; } /* Jaune - Présent dimanche matin */
    .statut-P-dim-Pm { background-color: #ffb3ba; color: #8b0000; font-weight: bold; } /* Rose - Présent dimanche après-midi */
    .statut-P-dim-Am-Pm { background-color: #e6ccff; color: #4b0082; font-weight: bold; } /* Violet clair - Présent dimanche matin et après-midi */
    .statut-A { background-color: #ffcccc; color: #cc0000; font-weight: bold; } /* Rouge clair - Absent */
    .statut-M { background-color: #ffd9b3; color: #cc6600; font-weight: bold; } /* Orange clair - Malade */
    .statut-M-Payer { background-color: #ffb3ff; color: #990099; font-weight: bold; } /* Magenta - Malade payé */
    .statut-OFF { background-color: #b3ffb3; color: #006600; font-weight: bold; } /* Vert menthe - Repos autorisé */
    
    /* Colonnes de comptage des statuts */
    .count-header {
        min-width: 45px;
        text-align: center;
        font-size: 0.7rem;
        padding: 5px 3px !important;
        vertical-align: middle;
        background-color: #495057;
        color: white;
        border-left: 2px solid #6c757d;
    }
    
    .total-header {
        background-color: #28a745 !important;
        font-weight: bold;
        min-width: 50px;
    }
    
    .count-cell {
        min-width: 45px;
        text-align: center;
        font-size: 0.85rem;
        font-weight: 500;
        padding: 8px 3px !important;
        vertical-align: middle;
        border-left: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }
    
    .total-cell {
        background-color: #d4edda !important;
        color: #155724;
        font-weight: bold;
        border-left: 2px solid #28a745;
    }
    
    /* Couleurs spécifiques pour les compteurs (plus claires) */
    .count-cell.statut-P-Am {
        background-color: #e8f5e8;
        color: #2e7d32;
    }
    
    .count-cell.statut-P-Pm {
        background-color: #e3f2fd;
        color: #1565c0;
    }
    
    .count-cell.statut-P-Am-Pm {
        background-color: #f1f8e9;
        color: #33691e;
    }
    
    .count-cell.statut-P-dim-Am {
        background-color: #fff3e0;
        color: #ef6c00;
    }
    
    .count-cell.statut-P-dim-Pm {
        background-color: #fce4ec;
        color: #c2185b;
    }
    
    .count-cell.statut-P-dim-Am-Pm {
        background-color: #f3e5f5;
        color: #7b1fa2;
    }
    
    .count-cell.statut-A {
        background-color: #ffebee;
        color: #d32f2f;
    }
    
    .count-cell.statut-M {
        background-color: #fff8e1;
        color: #f57c00;
    }
    
    .count-cell.statut-M-Payer {
        background-color: #e0f2f1;
        color: #00695c;
    }
    
    .count-cell.statut-OFF {
        background-color: #e8eaf6;
        color: #3f51b5;
    }
    
    .navigation-mois {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Navigation des mois -->
    <div class="navigation-mois">
        <a href="?mois={{ mois_precedent.mois }}&annee={{ mois_precedent.annee }}" class="btn btn-outline-primary">
            <i class="fas fa-chevron-left"></i> {{ mois_precedent.mois }}/{{ mois_precedent.annee }}
        </a>
        
        <h2 class="mb-0">
            <i class="fas fa-calendar-check me-2"></i>
            Pointage Journalier - {{ mois_nom }} {{ annee }}
        </h2>
        
        <a href="?mois={{ mois_suivant.mois }}&annee={{ mois_suivant.annee }}" class="btn btn-outline-primary">
            {{ mois_suivant.mois }}/{{ mois_suivant.annee }} <i class="fas fa-chevron-right"></i>
        </a>
    </div>

    <!-- Actions rapides -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="btn-group" role="group">
                <a href="{% url 'fleet_app:pointage_formulaire' %}" class="btn btn-success">
                    <i class="fas fa-plus"></i> Pointage individuel
                </a>
                <a href="{% url 'fleet_app:pointage_rapide' %}" class="btn btn-info">
                    <i class="fas fa-users"></i> Pointage rapide
                </a>
                <a href="{% url 'fleet_app:configuration_salaire' %}" class="btn btn-warning">
                    <i class="fas fa-coins"></i> Configuration Salaires
                </a>
                <a href="{% url 'fleet_app:historique_pointage' %}" class="btn btn-secondary">
                    <i class="fas fa-history"></i> Historique
                </a>
            </div>
        </div>
    </div>

    <!-- Légende des statuts -->
    <div class="card mb-3">
        <div class="card-body">
            <h6 class="card-title">Légende des statuts :</h6>
            <div class="row">
                {% for statut_code, statut_label in statut_choices %}
                <div class="col-md-3 mb-2">
                    <span class="badge statut-{{ statut_code|slice:':1' }}{{ statut_code|slice:'2:' }} me-2">{{ statut_code }}</span>
                    {{ statut_label }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Tableau de pointage -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-sm pointage-table mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="matricule-col">Matricule</th>
                            <th class="nom-col">Nom & Prénom</th>
                            <th class="poste-col">Poste</th>
                            <th class="date-col">Date Embauche</th>
                            <th class="salaire-col">Salaire Base (GNF)</th>
                            <th class="tel-col">Téléphone</th>
                            {% for jour_info in jours_mois %}
                            <th class="jour-header">
                                <div>{{ jour_info.jour }}</div>
                                <div>{{ jour_info.jour_semaine }}</div>
                            </th>
                            {% endfor %}
                            <!-- Colonnes de comptage des statuts -->
                            <th class="count-header" title="Présent matin">P(Am)</th>
                            <th class="count-header" title="Présent après-midi">P(Pm)</th>
                            <th class="count-header" title="Présent matin et après-midi">P(Am_&_Pm)</th>
                            <th class="count-header" title="Présent dimanche matin">P(dim_Am)</th>
                            <th class="count-header" title="Présent dimanche après-midi">P(dim_Pm)</th>
                            <th class="count-header" title="Présent dimanche matin et après-midi">P(dim_Am_&_Pm)</th>
                            <th class="count-header" title="Absent">A</th>
                            <th class="count-header" title="Malade">M</th>
                            <th class="count-header" title="Malade payé">M(Payer)</th>
                            <th class="count-header" title="Repos autorisé">OFF</th>
                            <th class="count-header total-header" title="Total pointages">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employe_data in employes_data %}
                        <tr>
                            <td class="matricule-col">
                                <span class="badge bg-primary">{{ employe_data.employe.matricule }}</span>
                            </td>
                            <td class="nom-col">
                                <strong>{{ employe_data.employe.nom }} {{ employe_data.employe.prenom }}</strong>
                            </td>
                            <td class="poste-col">
                                <small>{{ employe_data.employe.fonction|default:"Non spécifié" }}</small>
                            </td>
                            <td class="date-col">
                                <small>{{ employe_data.employe.date_embauche|date:"d/m/Y"|default:"Non spécifiée" }}</small>
                            </td>
                            <td class="salaire-col">
                                <small>{{ employe_data.employe.salaire_journalier|floatformat:0|intcomma }}</small>
                            </td>
                            <td class="tel-col">
                                <small>{{ employe_data.employe.telephone|default:"Non spécifié" }}</small>
                            </td>
                            {% for presence_info in employe_data.presences %}
                            <td class="pointage-cell {% if not presence_info.peut_pointer %}disabled{% endif %} 
                                {% if presence_info.presence %}statut-{{ presence_info.presence.statut|slice:':1' }}{{ presence_info.presence.statut|slice:'2:' }}{% endif %}"
                                data-employe-id="{{ employe_data.employe.id }}"
                                data-date="{{ presence_info.date|date:'Y-m-d' }}"
                                data-peut-pointer="{{ presence_info.peut_pointer|yesno:'true,false' }}">
                                {% if presence_info.presence %}
                                    {{ presence_info.presence.statut }}
                                {% else %}
                                    {% if presence_info.peut_pointer %}
                                        <i class="fas fa-plus text-muted"></i>
                                    {% endif %}
                                {% endif %}
                            </td>
                            {% endfor %}
                            <!-- Cellules de comptage des statuts -->
                            <td class="count-cell statut-P-Am">{{ employe_data.count_P_Am }}</td>
                            <td class="count-cell statut-P-Pm">{{ employe_data.count_P_Pm }}</td>
                            <td class="count-cell statut-P-Am-Pm">{{ employe_data.count_P_Am_Pm }}</td>
                            <td class="count-cell statut-P-dim-Am">{{ employe_data.count_P_dim_Am }}</td>
                            <td class="count-cell statut-P-dim-Pm">{{ employe_data.count_P_dim_Pm }}</td>
                            <td class="count-cell statut-P-dim-Am-Pm">{{ employe_data.count_P_dim_Am_Pm }}</td>
                            <td class="count-cell statut-A">{{ employe_data.count_A }}</td>
                            <td class="count-cell statut-M">{{ employe_data.count_M }}</td>
                            <td class="count-cell statut-M-Payer">{{ employe_data.count_M_Payer }}</td>
                            <td class="count-cell statut-OFF">{{ employe_data.count_OFF }}</td>
                            <td class="count-cell total-cell"><strong>{{ employe_data.count_total }}</strong></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{{ jours_mois|length|add:1 }}" class="text-center text-muted py-4">
                                Aucun employé actif trouvé.
                                <br>
                                <a href="{% url 'fleet_app:employe_list' %}" class="btn btn-sm btn-primary mt-2">
                                    Ajouter des employés
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour sélectionner le statut -->
<div class="modal fade" id="statutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sélectionner le statut</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Employé : <strong id="modal-employe-name"></strong></p>
                <p>Date : <strong id="modal-date"></strong></p>
                
                <div class="row">
                    {% for statut_code, statut_label in statut_choices %}
                    <div class="col-md-6 mb-2">
                        <button type="button" class="btn btn-outline-primary w-100 statut-btn" 
                                data-statut="{{ statut_code }}">
                            <span class="badge statut-{{ statut_code|slice:':1' }}{{ statut_code|slice:'2:' }} me-2">{{ statut_code }}</span>
                            {{ statut_label }}
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            </div>
        </div>
    </div>
</div>

<!-- Container pour les toasts -->
<div class="toast-container"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('statutModal'));
    let currentCell = null;
    let currentEmployeId = null;
    let currentDate = null;
    
    // Gestionnaire de clic sur les cellules de pointage
    document.querySelectorAll('.pointage-cell').forEach(cell => {
        cell.addEventListener('click', function() {
            if (this.dataset.peutPointer === 'false') {
                showToast('Impossible de pointer dans le futur', 'warning');
                return;
            }
            
            currentCell = this;
            currentEmployeId = this.dataset.employeId;
            currentDate = this.dataset.date;
            
            // Récupérer le nom de l'employé
            const employeRow = this.closest('tr');
            const employeName = employeRow.querySelector('.nom-col strong').textContent;
            
            // Formater la date
            const dateObj = new Date(currentDate);
            const formattedDate = dateObj.toLocaleDateString('fr-FR');
            
            // Mettre à jour le modal
            document.getElementById('modal-employe-name').textContent = employeName;
            document.getElementById('modal-date').textContent = formattedDate;
            
            modal.show();
        });
    });
    
    // Gestionnaire de clic sur les boutons de statut
    document.querySelectorAll('.statut-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const statut = this.dataset.statut;
            
            // Envoyer la requête AJAX
            fetch('{% url "fleet_app:pointage_ajax" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new URLSearchParams({
                    'employe_id': currentEmployeId,
                    'date': currentDate,
                    'statut': statut
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mettre à jour la cellule
                    currentCell.textContent = statut;
                    currentCell.className = `pointage-cell statut-${statut.slice(0,1)}${statut.slice(2)}`;
                    
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'error');
                }
                
                modal.hide();
            })
            .catch(error => {
                console.error('Erreur:', error);
                showToast('Erreur lors de l\'enregistrement', 'error');
                modal.hide();
            });
        });
    });
    
    // Fonction pour afficher les toasts
    function showToast(message, type) {
        const toastContainer = document.querySelector('.toast-container');
        const toastId = 'toast-' + Date.now();
        
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert">
                <div class="toast-header">
                    <i class="fas fa-${type === 'success' ? 'check-circle text-success' : type === 'warning' ? 'exclamation-triangle text-warning' : 'times-circle text-danger'} me-2"></i>
                    <strong class="me-auto">Pointage</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Supprimer le toast après qu'il soit caché
        toastElement.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }
});
</script>

<!-- CSRF Token pour AJAX -->
{% csrf_token %}
{% endblock %}
