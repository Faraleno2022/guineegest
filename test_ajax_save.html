<!DOCTYPE html>
<html>
<head>
    <title>Test AJAX Save</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <h2>Test de Sauvegarde AJAX</h2>
    
    <div>
        <label>Montant Absent:</label>
        <input type="number" id="montant_absent" value="0" />
        <button onclick="testSaveMontant('montant_absent', 'Absent')">Sauvegarder</button>
    </div>
    
    <div id="result"></div>
    
    <script>
        // Fonction pour r√©cup√©rer les cookies (n√©cessaire pour le token CSRF)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Test de la fonction de sauvegarde
        function testSaveMontant(fieldId, statusLabel) {
            const inputElement = document.getElementById(fieldId);
            if (!inputElement) {
                console.error('Champ non trouv√©:', fieldId);
                document.getElementById('result').innerHTML = '<p style="color: red;">Erreur: champ non trouv√©</p>';
                return;
            }
            
            const value = inputElement.value;
            const cleanValue = value === '' || value === null || value === undefined ? '0' : value;
            
            console.log(`üíæ TEST SAUVEGARDE: ${fieldId} = "${value}" (nettoy√©: ${cleanValue})`);
            document.getElementById('result').innerHTML = '<p style="color: blue;">Envoi de la requ√™te AJAX...</p>';
            
            fetch('http://127.0.0.1:8000/management/configuration-montants-statuts/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `${fieldId}=${encodeURIComponent(cleanValue)}`
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    document.getElementById('result').innerHTML = `<p style="color: green;">‚úÖ Succ√®s: ${data.message}</p>`;
                } else {
                    document.getElementById('result').innerHTML = `<p style="color: red;">‚ùå Erreur: ${data.error}</p>`;
                }
            })
            .catch(error => {
                console.error('Erreur AJAX:', error);
                document.getElementById('result').innerHTML = `<p style="color: red;">‚ùå Erreur de connexion: ${error.message}</p>`;
            });
        }
    </script>
</body>
</html>
